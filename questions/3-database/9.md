# InnoDB 기준, Undo 영역과 Redo 영역에 대해 설명해 주세요.

## 언두, 언두 로그란?
트랜잭션 수행 중에 수정된 데이터들이 버퍼 관리자의 버퍼 교체 알고리즘에 따라 디스크에 출력될 수 있다.
아직 트랜잭션이 commit되지 않은 경우에도, 디스크에 출력될 수 있으므로 트랜잭션이 정상 종료될 수 없다면 이는 원상 복구되어야 한다.
이를 UNDO라고 한다. 

이 데이터를 언두 로그라고 하며, 이를 통해 트랜잭션 롤백, 트랜잭션 격리 수준을 보장한다
.
InnoDB 스토리지 엔진은 트랜잭션과 격리 수준을 보장하기 위해 DML로 변경되기 이전 데이터를 백업한다. 이러한 변경 방식을 mvcc라고 한다.

MVCC란 Multi Version Concurrency Control의 약자로, 하나의 레코드에 대해 여러 개의 버전이 동시 관리된다는 것을 말한다.
만약 트랜잭션 격리 수준이 READ_COMMITTED 이상인 경우 변경된 데이터가 아직 커밋되지 않았을 때 조회한다면,
언두 영역에 있는 데이터를 반환하여 트랜잭션의 변경 전 내용을 돌려준다.

UNDO 데이터는 다음과 같이 기록된다.
* INSERT시, insert된 row 기록
* UPDATE시, 변경된 column의 바뀌기 전 값을 기록
* DELETE시, 지워진 모든 데이터 기록

대용량 데이터를 처리하는 트랜잭션이나 트랜잭션이 오랜 시간 사용되면 언두 로그의 양이 증가하고, 이는 쿼리 성능의 저하로 이어질 수 있다.

### 언두 테이블스페이스
언두로그가 저장되는 공간을 말한다.
MySQL 5.6버전 이전에는 언두 로그가 모두 시스템 테이블스페이스에 저장되었다. 
해당 테이블스페이스는 서버가 초기화 될 때 생성되므로, 확장이 어려웠다.
MYSQL 5.6버전 이후부터는 별도의 언두 로그 파일을 만들어 언두 로그를 관리할 수 있게 되었다.

하나의 언두 테이블스페이스는 최대 128개의 롤백 세그먼트를 가지게 되며, 각 세그먼트는 여러 언두 슬롯(Slot)을 갖는다.
하나의 세그먼트는 InnoDB 페이지 크기를 16바이트로 나눈 값의 개수 만큼 언두 슬롯을 갖는다.

기본적으로 하나의 트랜잭션은 하나의 롤백 세그먼트와 일대일 대응된다. 

만약 페이지 크기가 4KB(4096Byte)라면, 4096/16=256개의 언두 슬롯을 갖게 된다.

### 리두, 리두 로그란
트랜잭션의 ACID 속성 중 영속성과 가장 밀접한 관련이 있다. REDO란, 이미 커밋한 트랜잭션의 수정은 어떤 경우에도 유지되어야 한다.
MySQL 서버가 비정상적으로 종료되었을 때 데이터 파일에 기록되지 못한 데이터는 잃어서는 안된다.
이때, DB 장애 발생 시 복구에 사용되는 로그를 REDO LOG라고 한다.

리두 로그에는 트랜잭션의 변경 작업에 대한 세부 정보가 포함되어 있다. 
* 트랜잭션 식별자, 변경 작업 유형(insert, delete 등)
* 수정 데이터 위치, 수정 시간(timestamp)
* 커밋 정보

### InnoDB Buffer Pool

![image](https://github.com/COW-edu/backend-cs-study/assets/59856002/f89ce178-d0cf-44ae-959d-ca4d4de6e235)

Buffer Pool이란, InnoDB에서 테이블 및 인덱스 데이터 캐싱을 위해 이용하는 메모리 공간이다.
해당 풀의 크기가 크다면 캐싱되는 데이터의 양이 증가하므로 직접적으로 Disk에 접근하는 횟수가 감소하여 성능 향상을 이룰 수 있다.

일반적인 dbms에서는 Disk I/O를 줄이기 위해 트랜잭션의 변경 내용이 바로 Table Space에 들어가는 것이 아니고, 메모리 영역(Buffer Pool, Log Buffer)에 저장되며 추후 Table영역으로 flush 된다.

하지만 해당 Buffer Pool은 결국 메모리 공간이라, 장애가 발생하면 해당 Buffer Pool 내의 데이터가 유실될 가능성이 높다.

이떄, Redo Log File을 이용한다.

Buffer Pool은 메모리 영역이므로, 용량이 제한적이다. 따라서 Undo Log 처럼 Checkpoint 이벤트가 발생하면 Redo Log Buffer에 있던 데이터들을 Disk에 File로 저장하는데, 이를 Redo Log File이라고 한다.

Redo 로그 파일은 두개의 파일로 구성되며, 한 파일이 가득 차면 `log switch`가 발생한다.
이떄, Checkpoint 이벤트가 발생하며 Buffer Pool 캐시에 있는 데이터들이 디스크에 기록된다.

결국 마지막 Checkpoint 이후 변경된 Buffer Pool에 있던 데이터는 모두 유실된다. 
하지만, 해당 데이터는 Redo Log File에 기록되므로 해당 파일을 사용하여 데이터를 복구한다.

### References
* https://loosie.tistory.com/527
* https://d2.naver.com/helloworld/407507
* Real Mysql 8.0 4장 아키텍처
